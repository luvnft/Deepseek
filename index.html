<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" />
  <title>Stelmina - Salon de Înfrumusețare</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>

  <style>
    :root {
      --neon-blue: #64ffff;
      --space-black: #0a0a1a;
      --cyber-purple: #1a1a3a;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(45deg, var(--space-black), var(--cyber-purple));
      font-family: 'Segoe UI', sans-serif;
      overflow: hidden;
      touch-action: none;
    }

    .chat-container {
      position: fixed;
      top: 20px;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: rgba(16,16,32,0.9);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      border: 1px solid rgba(100,255,255,0.2);
      box-shadow: 0 0 40px rgba(100,255,255,0.1);
      display: flex;
      flex-direction: column;
      z-index: 10;
    }

    .chat-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(100,255,255,0.1);
      background: linear-gradient(90deg, rgba(16,16,32,0.9) 0%, rgba(32,32,64,0.9) 100%);
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    #chatbox {
      flex: 1;
      padding: 1.5rem;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .message {
      max-width: 85%;
      margin: 12px 0;
      padding: 1rem;
      border-radius: 15px;
      animation: messagePop 0.3s ease-out;
      position: relative;
      backdrop-filter: blur(5px);
    }

    .message.bot {
      background: linear-gradient(45deg, rgba(32,32,64,0.3), rgba(16,16,32,0.2));
      border: 1px solid rgba(100,255,255,0.15);
      color: #e0e0ff;
    }

    .message.user {
      background: linear-gradient(45deg, rgba(100,150,255,0.15), rgba(100,200,255,0.1));
      border: 1px solid rgba(100,255,255,0.2);
      margin-left: auto;
      color: #c8ffff;
    }

    @keyframes messagePop {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .input-area {
      padding: 1.5rem;
      border-top: 1px solid rgba(100,255,255,0.1);
      display: flex;
      gap: 12px;
    }

    #userInput {
      flex: 1;
      background: rgba(8,8,16,0.6);
      border: 1px solid rgba(100,255,255,0.2);
      color: var(--neon-blue);
      padding: 1rem;
      border-radius: 12px;
      font-size: 16px;
    }

    #sendButton {
      background: linear-gradient(135deg, var(--neon-blue) 0%, #3264ff 100%);
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    #adminView {
      display: none;
      border-top: 1px solid rgba(100,255,255,0.1);
      overflow-y: auto;
      background: rgba(8,8,16,0.95);
    }

    .admin-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 2rem;
      padding: 2rem;
    }

    .admin-section {
      background: rgba(16,16,32,0.9);
      border: 1px solid rgba(100,255,255,0.15);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }

    .appointment-card {
      background: rgba(24,24,48,0.9);
      border: 1px solid rgba(100,255,255,0.1);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      display: grid;
      grid-template-columns: repeat(4, 1fr) 120px;
      gap: 1rem;
      align-items: center;
    }

    .appointment-header {
      font-size: 0.9rem;
      color: #64ffff;
      margin-bottom: 0.5rem;
    }

    .appointment-data {
      color: #e0e0ff;
      font-weight: 500;
    }

    .fc-toolbar-title {
      color: #64ffff !important;
      font-weight: 600 !important;
    }

    @media (max-width: 768px) {
      .admin-grid {
        grid-template-columns: 1fr;
      }
      
      .appointment-card {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <h1 class="text-2xl font-bold text-[#64ffff] flex items-center gap-2">
        <i class="fas fa-robot"></i>
        Stelmina
      </h1>
      <button
        id="toggleViewBtn"
        class="ml-auto bg-[#3264ff] hover:bg-[#64ffff] text-white px-4 py-2 rounded-lg transition-all"
      >
        <i class="fas fa-user-cog mr-2"></i> Admin
      </button>
    </div>

    <div id="chatbox"></div>

    <div id="adminView">
      <div class="admin-grid">
        <div class="admin-section">
          <div id="calendar"></div>
        </div>

        <div class="admin-section">
          <h2 class="text-xl font-semibold text-[#64ffff] mb-4">
            <i class="fas fa-calendar-alt mr-2"></i>Programări
          </h2>
          <div class="flex gap-4 mb-4">
            <button
              id="addAppointmentBtn"
              class="bg-[#3264ff] hover:bg-[#64ffff] text-white px-4 py-2 rounded-lg transition-all"
            >
              <i class="fas fa-plus mr-2"></i>Adaugă
            </button>
            <button
              id="refreshAppointments"
              class="bg-[#3264ff] hover:bg-[#64ffff] text-white px-4 py-2 rounded-lg transition-all"
            >
              <i class="fas fa-sync-alt mr-2"></i>Actualizează
            </button>
          </div>
          <div id="appointmentsList"></div>
        </div>
      </div>
    </div>

    <div class="input-area">
      <input
        type="text"
        id="userInput"
        placeholder="Scrie mesajul tău..."
        maxlength="200"
        list="services"
      />
      <datalist id="services">
        <option value="Pensat" />
        <option value="Masaj Sculptural" />
        <option value="Îngrijire facială" />
      </datalist>
      <button id="sendButton">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      orderBy,
      where,
      deleteDoc,
      doc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBwCFGYsXp5zjWIHAcQbOmdd31e7bDN8mk",
      authDomain: "stelmina-19617.firebaseapp.com",
      projectId: "stelmina-19617",
      storageBucket: "stelmina-19617.appspot.com",
      messagingSenderId: "828872692313",
      appId: "1:828872692313:web:adc44bf28b54b26279d748",
      measurementId: "G-FQ44LY0Y32"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DOM Elements
    const elements = {
      chatbox: document.getElementById("chatbox"),
      userInput: document.getElementById("userInput"),
      sendButton: document.getElementById("sendButton"),
      adminView: document.getElementById("adminView"),
      toggleViewBtn: document.getElementById("toggleViewBtn"),
      appointmentsList: document.getElementById("appointmentsList"),
      calendar: document.getElementById("calendar")
    };

    // State Management
    let userName = localStorage.getItem("chatbotUserName") || null;
    let chartInstance = null;

    // Chat Functions
    function initializeChat() {
      const history = JSON.parse(localStorage.getItem("chatHistory")) || [];
      history.forEach((msg) => addMessage(msg.text, msg.isUser, false));
      if (history.length === 0) {
        addMessage(
          `Bună! ✨ Sunt asistentul virtual al salonului Stelmina.<br>
           Cu ce te pot ajuta astăzi?`,
          false,
          false
        );
      }
    }

    function addMessage(text, isUser, save = true) {
      const messageDiv = document.createElement("div");
      messageDiv.classList.add("message", isUser ? "user" : "bot");
      messageDiv.innerHTML = text;
      elements.chatbox.appendChild(messageDiv);
      elements.chatbox.scrollTop = elements.chatbox.scrollHeight;

      if (save) {
        const history = JSON.parse(localStorage.getItem("chatHistory")) || [];
        history.push({ text, isUser });
        localStorage.setItem("chatHistory", JSON.stringify(history));
      }
    }

    // Appointment Handling
    async function handleAppointmentCreation(text) {
      try {
        const name = extractUserName(text) || userName;
        if (!name) throw new Error("Nume necesar");
        
        const serviceMatch = text.match(/pensat|masaj\s*sculptural|îngrijire\s*facială/i);
        if (!serviceMatch) throw new Error("Serviciu invalid");
        
        const date = parseDate(text);
        if (date < new Date()) throw new Error("Data în trecut");
        
        if (!(await checkAvailability(date))) {
          throw new Error("Interval ocupat");
        }

        await saveAppointment(name, date, serviceMatch[0]);
        return `✅ Programare confirmată pentru ${name} pe ${date.toLocaleString('ro-RO')}`;
      } catch (error) {
        return `⚠️ Eroare: ${error.message}`;
      }
    }

    async function saveAppointment(name, date, service) {
      try {
        const docRef = await addDoc(collection(db, "appointments"), {
          clientName: name.trim(),
          date: date.toISOString(),
          service: service.toLowerCase(),
          timestamp: new Date().toISOString(),
          status: "confirmed"
        });
        console.log('Appointment saved:', docRef.id);
        return true;
      } catch (error) {
        console.error('Save error:', error);
        throw error;
      }
    }

    // Admin Panel Functions
    async function showAppointments() {
      elements.appointmentsList.innerHTML = '';
      const q = query(collection(db, "appointments"), orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);

      snapshot.forEach((doc) => {
        const data = doc.data();
        const card = document.createElement('div');
        card.className = 'appointment-card';
        card.innerHTML = `
          <div>
            <div class="appointment-header">Nume</div>
            <div class="appointment-data">${data.clientName}</div>
          </div>
          <div>
            <div class="appointment-header">Dată</div>
            <div class="appointment-data">${new Date(data.date).toLocaleString('ro-RO')}</div>
          </div>
          <div>
            <div class="appointment-header">Serviciu</div>
            <div class="appointment-data">${data.service}</div>
          </div>
          <div>
            <div class="appointment-header">Status</div>
            <div class="appointment-data text-green-400">${data.status}</div>
          </div>
          <div class="flex gap-2">
            <button class="edit-btn px-3 py-2 bg-blue-600 rounded-lg" data-id="${doc.id}">
              <i class="fas fa-edit"></i>
            </button>
            <button class="delete-btn px-3 py-2 bg-red-600 rounded-lg" data-id="${doc.id}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;

        card.querySelector('.delete-btn').addEventListener('click', async () => {
          await deleteDoc(doc(db, "appointments", doc.id));
          showAppointments();
        });

        elements.appointmentsList.appendChild(card);
      });
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      initializeChat();
      elements.toggleViewBtn.addEventListener('click', async () => {
        const password = prompt("Parola admin:");
        if (password === "1234") {
          elements.adminView.style.display = elements.adminView.style.display === 'none' ? 'block' : 'none';
          if (elements.adminView.style.display === 'block') {
            await showAppointments();
            initCalendar();
          }
        }
      });

      elements.sendButton.addEventListener('click', async () => {
        const text = elements.userInput.value.trim();
        if (!text) return;

        elements.userInput.value = '';
        addMessage(text, true);

        const response = await handleAppointmentCreation(text);
        addMessage(response, false);
        if (elements.adminView.style.display === 'block') {
          await showAppointments();
        }
      });
    });
  </script>
</body>
</html>
