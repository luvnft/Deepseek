<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Stelmina - Salon de Înfrumusețare</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root {
      --neon-blue: #64ffff;
      --space-black: #0a0a1a;
      --cyber-purple: #1a1a3a;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(45deg, var(--space-black), var(--cyber-purple));
      font-family: 'Segoe UI', sans-serif;
      overflow: hidden;
      touch-action: none;
    }

    .chat-container {
      position: fixed;
      top: 20px;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: rgba(16,16,32,0.9);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      border: 1px solid rgba(100,255,255,0.2);
      box-shadow: 0 0 40px rgba(100,255,255,0.1);
      display: flex;
      flex-direction: column;
      z-index: 1;
    }

    .chat-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(100,255,255,0.1);
      background: linear-gradient(90deg, rgba(16,16,32,0.9) 0%, rgba(32,32,64,0.9) 100%);
      display: flex;
      align-items: center;
    }

    #chatbox {
      flex: 1;
      padding: 1.5rem;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .message {
      max-width: 85%;
      margin: 12px 0;
      padding: 1rem;
      border-radius: 15px;
      animation: messagePop 0.3s ease-out;
      position: relative;
      backdrop-filter: blur(5px);
    }

    .message.bot {
      background: linear-gradient(45deg, rgba(32,32,64,0.3), rgba(16,16,32,0.2));
      border: 1px solid rgba(100,255,255,0.15);
      color: #e0e0ff;
    }

    .message.user {
      background: linear-gradient(45deg, rgba(100,150,255,0.15), rgba(100,200,255,0.1));
      border: 1px solid rgba(100,255,255,0.2);
      margin-left: auto;
      color: #c8ffff;
    }

    @keyframes messagePop {
      0% { opacity: 0; transform: translateY(20px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .input-area {
      padding: 1.5rem;
      border-top: 1px solid rgba(100,255,255,0.1);
      display: flex;
      gap: 12px;
    }

    #userInput {
      flex: 1;
      background: rgba(8,8,16,0.6);
      border: 1px solid rgba(100,255,255,0.2);
      color: var(--neon-blue);
      padding: 1rem;
      border-radius: 12px;
      font-size: 16px;
    }

    #sendButton {
      background: linear-gradient(135deg, var(--neon-blue) 0%, #3264ff 100%);
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    #sendButton:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(100,255,255,0.3);
    }

    /* Admin Styles */
    #adminView {
      display: none;
      padding: 1.5rem;
      border-top: 1px solid rgba(100,255,255,0.1);
    }

    #appointmentsList {
      margin-top: 1rem;
      border: 1px solid rgba(100,255,255,0.2);
      border-radius: 8px;
      overflow: hidden;
    }

    .appointment-item {
      padding: 1rem;
      border-bottom: 1px solid rgba(100,255,255,0.1);
      display: grid;
      grid-template-columns: 1fr 2fr 1.5fr;
      gap: 1rem;
      align-items: center;
      background: rgba(16,16,32,0.6);
      transition: background 0.3s ease;
    }

    .appointment-item:hover {
      background: rgba(32,32,64,0.3);
    }

    .appointment-time {
      color: #64ffff;
      font-weight: 500;
    }

    .admin-header {
      grid-template-columns: 1fr 2fr 1.5fr;
      gap: 1rem;
      padding: 0.75rem 1rem;
      background: rgba(26,26,58,0.9);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <h1 class="text-2xl font-bold text-[#64ffff]">
        <i class="fas fa-robot mr-2"></i>
        Stelmina
      </h1>
      <button id="toggleViewBtn" class="ml-auto bg-[#3264ff] hover:bg-[#64ffff] text-white px-4 py-2 rounded-lg transition-all">
        <i class="fas fa-user-cog mr-2"></i> Admin
      </button>
    </div>

    <div id="chatbox">
      <div class="message bot">
        Bună! ✨ Sunt asistentul virtual al salonului Stelmina.<br><br>
        Te rog să precizezi:<br>
        1. Numele tău<br>
        2. Data și ora dorită<br>
        3. Serviciul solicitat
      </div>
    </div>

    <div id="adminView">
      <h2 class="text-xl font-semibold text-[#64ffff] mb-4">
        <i class="fas fa-calendar-alt mr-2"></i>Programări
      </h2>
      
      <div class="flex gap-4 mb-4">
        <button id="addAppointmentBtn" class="bg-[#3264ff] hover:bg-[#64ffff] text-white px-4 py-2 rounded-lg transition-all">
          <i class="fas fa-plus mr-2"></i>Adaugă
        </button>
        <button id="refreshAppointments" class="bg-[#3264ff] hover:bg-[#64ffff] text-white px-4 py-2 rounded-lg transition-all">
          <i class="fas fa-sync-alt mr-2"></i>Actualizează
        </button>
      </div>

      <div class="admin-header grid grid-cols-3 gap-4 px-4 py-2">
        <div class="font-semibold text-[#64ffff]">Client</div>
        <div class="font-semibold text-[#64ffff]">Dată și Ora</div>
        <div class="font-semibold text-[#64ffff]">Serviciu</div>
      </div>

      <div id="appointmentsList" class="rounded-b-lg"></div>

      <div class="mt-6">
        <h3 class="text-lg font-semibold text-[#64ffff] mb-3">
          <i class="fas fa-cogs mr-2"></i>Configurare Chatbot
        </h3>
        <textarea id="instructionsInput" class="w-full p-3 rounded-lg bg-[#0a0a1a] border border-[#64ffff]/30 text-white focus:border-[#64ffff] focus:ring-2 focus:ring-[#64ffff]/50" 
          placeholder="Scrie instrucțiuni personalizate pentru chatbot..." rows="4"></textarea>
        <button id="sendInstructionsBtn" class="mt-3 bg-[#3264ff] hover:bg-[#64ffff] text-white px-6 py-2 rounded-lg transition-all">
          <i class="fas fa-upload mr-2"></i>Salvează Configurație
        </button>
      </div>
    </div>

    <div class="input-area">
      <input type="text" id="userInput" placeholder="Scrie mesajul tău..." maxlength="200">
      <button id="sendButton">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      getDocs,
      query,
      orderBy,
      where
    } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

    // Configurația Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBwCFGYsXp5zjWIHAcQbOmdd31e7bDN8mk",
      authDomain: "stelmina-19617.firebaseapp.com",
      projectId: "stelmina-19617",
      storageBucket: "stelmina-19617.appspot.com",
      messagingSenderId: "828872692313",
      appId: "1:828872692313:web:adc44bf28b54b26279d748",
      measurementId: "G-FQ44LY0Y32"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Elemente DOM
    const chatbox = document.getElementById('chatbox');
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    let userName = localStorage.getItem('chatbotUserName') || null;

    // Offset fus orar
    const timezoneOffset = new Date().getTimezoneOffset() * 60000;

    // Inițializare chat
    window.addEventListener('DOMContentLoaded', () => {
      if (userName) {
        addMessage(`Bună revenire, ${userName}! Cu ce vă pot ajuta astăzi? ✨`, false);
      }
    });

    function addMessage(text, isUser) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message', isUser ? 'user' : 'bot');
      messageDiv.innerHTML = text;
      chatbox.appendChild(messageDiv);
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    // Extrage numele utilizatorului din text
    function extractUserName(text) {
      const patterns = [
        /(?:sunt|numele\s*(meu)?\s*este?|mă\s*cheamă)\s+([A-Za-zȘșȚțÂâÎîĂă]+)/i,
        /\b([A-ZȘȚÂĂÎ][a-zșțâîă]+)\b/
      ];
      
      for (const pattern of patterns) {
        const match = text.match(pattern);
        if (match) {
          const name = (match[2] || match[1]).trim();
          localStorage.setItem('chatbotUserName', name);
          userName = name;
          return name;
        }
      }
      return userName;
    }

    // Funcție pentru a apela API-ul AI (ex: /api/chat)
    async function getAIChatResponse(prompt) {
      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: prompt })
        });
        const data = await response.json();
        return data.reply;
      } catch (error) {
        console.error('Eroare API:', error);
        return '⏳ Momentan avem dificultăți tehnice. Vă rugăm să încercați mai târziu.';
      }
    }

    // Funcție de parsare a datei cu corecția fusului orar
    function parseDate(input) {
      const now = new Date();
      const weekdays = ['duminică', 'luni', 'marți', 'miercuri', 'joi', 'vineri', 'sâmbăta'];

      // Funcție internă de ajustare
      const adjustTimezone = (date) => new Date(date.getTime() - timezoneOffset);

      let finalDate = adjustTimezone(new Date(now));

      // Parsare zile săptămânii
      const weekdayMatch = input.match(new RegExp(`\\b(${weekdays.join('|')})\\b`, 'i'));
      if (weekdayMatch) {
        const targetDay = weekdays.findIndex(d => d === weekdayMatch[1].toLowerCase());
        const currentDay = now.getDay();
        let dayOffset = targetDay - currentDay;
        if (dayOffset <= 0) dayOffset += 7;
        finalDate.setDate(now.getDate() + dayOffset);
      }
      else if (input.toLowerCase().includes('mâine')) {
        finalDate.setDate(now.getDate() + 1);
      }

      // Parsare oră
      const timeMatch = input.match(/(\d{1,2})(?:[:.](\d{2}))?\s*(am|pm)?/i);
      if (timeMatch) {
        let hours = parseInt(timeMatch[1]);
        const minutes = timeMatch[2] ? parseInt(timeMatch[2]) : 0;
        const period = timeMatch[3]?.toLowerCase();

        if (period === 'pm' && hours < 12) hours += 12;
        if (period === 'am' && hours === 12) hours = 0;

        finalDate.setHours(hours, minutes, 0, 0);
      }

      return finalDate;
    }

    // Verifică disponibilitatea în Firestore
    async function checkAvailability(date) {
      const colRef = collection(db, "appointments");
      const q = query(colRef, where("date", "==", date.toISOString()));
      const snapshot = await getDocs(q);
      return snapshot.empty;
    }

    // Salvează programarea în Firestore
    async function saveAppointment(name, date, service) {
      try {
        await addDoc(collection(db, "appointments"), {
          clientName: name,
          date: date.toISOString(),
          service: service.toLowerCase(),
          timestamp: new Date().toISOString(),
          status: "confirmed"
        });
        return true;
      } catch (error) {
        console.error("Eroare salvare:", error);
        return false;
      }
    }

    // Returnează răspunsul final pe baza textului utilizatorului
    async function handleUserMessage(text) {
      try {
        // Extrage nume
        const name = extractUserName(text);
        // Identifică serviciul
        const serviceMatch = text.match(/pensat|masaj sculptural bucal|îngrijire facială/i);
        // Parsează data
        const date = parseDate(text);

        // Verifică dacă avem de-a face cu o programare
        if (name && serviceMatch && date) {
          const isAvailable = await checkAvailability(date);
          if (!isAvailable) {
            return "⏰ Ne pare rău, intervalul este deja ocupat. Vă rugăm alegeți altă oră.";
          }
          const saved = await saveAppointment(name, date, serviceMatch[0]);
          if (saved) {
            const formattedDate = date.toLocaleString('ro-RO', {
              timeZone: 'Europe/Bucharest',
              weekday: 'long',
              day: 'numeric',
              month: 'long',
              hour: '2-digit',
              minute: '2-digit'
            });
            return `✅ Programare confirmată!<br><br>
              👤 ${name}<br>
              📅 ${formattedDate}<br>
              💼 ${serviceMatch[0]}`;
          } else {
            return "⚠️ Eroare la salvarea programării. Vă rugăm încercați din nou.";
          }
        }
      } catch (error) {
        console.error('Eroare programare:', error);
      }

      // Dacă nu e programare, încercăm răspunsul AI
      return await getAIChatResponse(text);
    }

    // Funcție de afișare a programărilor în admin view
    async function showAppointments() {
      const appointmentsList = document.getElementById('appointmentsList');
      appointmentsList.innerHTML = '';

      const q = query(collection(db, "appointments"), orderBy("timestamp", "desc"));
      const querySnapshot = await getDocs(q);

      querySnapshot.forEach((doc) => {
        const data = doc.data();
        const item = document.createElement('div');
        item.className = 'appointment-item';

        const date = new Date(data.date).toLocaleString('ro-RO', {
          weekday: 'long',
          day: 'numeric',
          month: 'long',
          hour: '2-digit',
          minute: '2-digit'
        });

        item.innerHTML = `
          <div class="appointment-name">
            <i class="fas fa-user text-[#64ffff]"></i>
            ${data.clientName}
          </div>
          <div class="appointment-time">${date}</div>
          <div class="appointment-service">
            <i class="fas fa-spa text-[#64ffff]"></i>
            ${data.service}
          </div>
        `;
        appointmentsList.appendChild(item);
      });
    }

    // Evenimentul principal - trimiterea mesajului de către utilizator
    sendButton.addEventListener('click', async () => {
      const text = userInput.value.trim();
      if (!text) return;

      userInput.value = '';
      addMessage(text, true);

      try {
        const response = await handleUserMessage(text);
        addMessage(response, false);
      } catch (error) {
        console.error("Eroare:", error);
        addMessage("⚠️ A apărut o eroare. Vă rugăm încercați din nou.", false);
      }
    });

    // Intrare "Enter" în câmpul de text
    userInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendButton.click();
    });

    // Funcționalitate buton Admin
    document.getElementById('toggleViewBtn').addEventListener('click', () => {
      const adminView = document.getElementById('adminView');
      adminView.style.display = adminView.style.display === 'none' ? 'block' : 'none';
      if (adminView.style.display === 'block') {
        showAppointments();
      }
    });

    // Reîmprospătare listă programări
    document.getElementById('refreshAppointments').addEventListener('click', showAppointments);

    // Adăugare programare din admin
    document.getElementById('addAppointmentBtn').addEventListener('click', async () => {
      const name = prompt('Nume client:');
      const dateInput = prompt('Dată și oră (ex: "joi 15:30" sau "2024-03-25 14:00")');
      const service = prompt('Serviciu:');

      if (name && dateInput && service) {
        const date = parseDate(dateInput);
        if (await checkAvailability(date)) {
          await saveAppointment(name, date, service);
          showAppointments();
        } else {
          alert('Interval orar indisponibil!');
        }
      }
    });

    // Buton de salvare a configurației chatbot (exemplu)
    document.getElementById('sendInstructionsBtn').addEventListener('click', () => {
      const instructions = document.getElementById('instructionsInput').value;
      console.log("Instrucțiuni chatbot:", instructions);
      alert("Instrucțiunile au fost salvate (exemplu).");
    });
  </script>
</body>
</html>
