<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no">
  <title>Stelmina - Salon de √énfrumuse»õare</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css' rel='stylesheet'>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js'></script>

  <style>
    :root {
      --neon-blue: #64ffff;
      --space-black: #0a0a1a;
      --cyber-purple: #1a1a3a;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(45deg, var(--space-black), var(--cyber-purple));
      font-family: 'Segoe UI', sans-serif;
      overflow: hidden;
      touch-action: none;
    }

    .chat-container {
      position: fixed;
      top: 20px;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: rgba(16,16,32,0.9);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      border: 1px solid rgba(100,255,255,0.2);
      box-shadow: 0 0 40px rgba(100,255,255,0.1);
      display: flex;
      flex-direction: column;
      z-index: 1;
    }

    .chat-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(100,255,255,0.1);
      background: linear-gradient(90deg, rgba(16,16,32,0.9) 0%, rgba(32,32,64,0.9) 100%);
      display: flex;
      align-items: center;
    }

    #chatbox {
      flex: 1;
      padding: 1.5rem;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .message {
      max-width: 85%;
      margin: 12px 0;
      padding: 1rem;
      border-radius: 15px;
      animation: messagePop 0.3s ease-out;
      position: relative;
      backdrop-filter: blur(5px);
    }

    .message.bot {
      background: linear-gradient(45deg, rgba(32,32,64,0.3), rgba(16,16,32,0.2));
      border: 1px solid rgba(100,255,255,0.15);
      color: #e0e0ff;
    }

    .message.user {
      background: linear-gradient(45deg, rgba(100,150,255,0.15), rgba(100,200,255,0.1));
      border: 1px solid rgba(100,255,255,0.2);
      margin-left: auto;
      color: #c8ffff;
    }

    @keyframes messagePop {
      0% { opacity: 0; transform: translateY(20px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .input-area {
      padding: 1.5rem;
      border-top: 1px solid rgba(100,255,255,0.1);
      display: flex;
      gap: 12px;
    }

    #userInput {
      flex: 1;
      background: rgba(8,8,16,0.6);
      border: 1px solid rgba(100,255,255,0.2);
      color: var(--neon-blue);
      padding: 1rem;
      border-radius: 12px;
      font-size: 16px;
    }

    #sendButton {
      background: linear-gradient(135deg, var(--neon-blue) 0%, #3264ff 100%);
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    #sendButton:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(100,255,255,0.3);
    }

    #adminView {
      display: none;
      padding: 1.5rem;
      border-top: 1px solid rgba(100,255,255,0.1);
    }

    #appointmentsList {
      margin-top: 1rem;
      border: 1px solid rgba(100,255,255,0.2);
      border-radius: 8px;
      overflow: hidden;
    }

    .appointment-item {
      padding: 1rem;
      border-bottom: 1px solid rgba(100,255,255,0.1);
      display: grid;
      grid-template-columns: 1fr 2fr 1.5fr;
      gap: 1rem;
      align-items: center;
      background: rgba(16,16,32,0.6);
      transition: background 0.3s ease;
    }

    .appointment-item:hover {
      background: rgba(32,32,64,0.3);
    }

    #calendar {
      background: rgba(16,16,32,0.9);
      border-radius: 12px;
      padding: 1rem;
      margin: 1rem 0;
    }

    .fc-toolbar-title {
      color: #64ffff !important;
    }

    @media (max-width: 640px) {
      .chat-container {
        top: 10px;
        bottom: 10px;
        left: 10px;
        right: 10px;
      }
      
      .message {
        max-width: 95%;
        font-size: 14px;
        padding: 8px;
      }
      
      #userInput {
        padding: 8px;
        font-size: 14px;
      }

      .appointment-item {
        grid-template-columns: 1fr;
        gap: 4px;
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <h1 class="text-2xl font-bold text-[#64ffff]">
        <i class="fas fa-robot mr-2"></i>
        Stelmina
      </h1>
      <button id="toggleViewBtn" class="ml-auto bg-[#3264ff] hover:bg-[#64ffff] text-white px-4 py-2 rounded-lg transition-all">
        <i class="fas fa-user-cog mr-2"></i> Admin
      </button>
    </div>

    <div id="chatbox"></div>

    <div id="adminView">
      <div id="calendar"></div>
      
      <h2 class="text-xl font-semibold text-[#64ffff] mb-4">
        <i class="fas fa-calendar-alt mr-2"></i>ProgramƒÉri
      </h2>
      
      <div class="flex gap-4 mb-4">
        <button id="addAppointmentBtn" class="bg-[#3264ff] hover:bg-[#64ffff] text-white px-4 py-2 rounded-lg transition-all">
          <i class="fas fa-plus mr-2"></i>AdaugƒÉ
        </button>
        <button id="refreshAppointments" class="bg-[#3264ff] hover:bg-[#64ffff] text-white px-4 py-2 rounded-lg transition-all">
          <i class="fas fa-sync-alt mr-2"></i>ActualizeazƒÉ
        </button>
      </div>

      <div id="appointmentsList" class="rounded-b-lg"></div>

      <div class="mt-6">
        <h3 class="text-lg font-semibold text-[#64ffff] mb-3">Statistici</h3>
        <canvas id="reportsChart" class="bg-[#0a0a1a] p-4 rounded-lg"></canvas>
      </div>
    </div>

    <div class="input-area">
      <input type="text" id="userInput" placeholder="Scrie mesajul tƒÉu..." maxlength="200" list="services">
      <datalist id="services">
        <option value="Pensat">
        <option value="Masaj sculptural bucal">
        <option value="√éngrijire facialƒÉ premium">
      </datalist>
      <button id="sendButton">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      addDoc,
      getDocs,
      query,
      orderBy,
      where,
      deleteDoc,
      doc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBwCFGYsXp5zjWIHAcQbOmdd31e7bDN8mk",
      authDomain: "stelmina-19617.firebaseapp.com",
      projectId: "stelmina-19617",
      storageBucket: "stelmina-19617.appspot.com",
      messagingSenderId: "828872692313",
      appId: "1:828872692313:web:adc44bf28b54b26279d748",
      measurementId: "G-FQ44LY0Y32"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let chartInstance = null;

    const chatbox = document.getElementById('chatbox');
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    let userName = localStorage.getItem('chatbotUserName') || null;

    const loadChatHistory = () => {
      const history = JSON.parse(localStorage.getItem('chatHistory')) || [];
      history.forEach(msg => addMessage(msg.text, msg.isUser, false));
      if(history.length === 0) {
        addMessage(`BunƒÉ! ‚ú® Sunt asistentul virtual al salonului Stelmina.<br><br>
          Te rog sƒÉ precizezi:<br>
          1. Numele tƒÉu<br>
          2. Data »ôi ora doritƒÉ<br>
          3. Serviciul solicitat`, false, false);
      }
    }

    window.addEventListener('DOMContentLoaded', loadChatHistory);

    function addMessage(text, isUser, save = true) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message', isUser ? 'user' : 'bot');
      messageDiv.innerHTML = text;
      chatbox.appendChild(messageDiv);
      chatbox.scrollTop = chatbox.scrollHeight;

      if(save) {
        const history = JSON.parse(localStorage.getItem('chatHistory')) || [];
        history.push({ text, isUser });
        localStorage.setItem('chatHistory', JSON.stringify(history));
      }
    }

    const validateName = (name) => {
      return /^[A-Za-z»ò»ô»ö»õ√Ç√¢√é√ÆƒÇƒÉ\s]{2,30}$/.test(name);
    }

    const validateDateTime = (date) => {
      const now = new Date();
      const minDate = new Date(now.getTime() + 30 * 60000);
      const maxDate = new Date(now.setMonth(now.getMonth() + 3));
      
      if(date < minDate) throw new Error('Data trebuie sƒÉ fie cu minim 30 de minute √Æn viitor');
      if(date > maxDate) throw new Error('Putem programa maxim 3 luni √Æn avans');
      
      const hours = date.getHours();
      if(hours < 9 || hours >= 20) throw new Error('ProgramƒÉm doar √Æntre 9:00 »ôi 20:00');
      
      return true;
    }

    const initCalendar = async () => {
      const calendarEl = document.getElementById('calendar');
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        events: await fetchAppointmentsAsEvents(),
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        eventColor: '#64ffff',
        eventTextColor: '#0a0a1a'
      });
      calendar.render();
    }

    const fetchAppointmentsAsEvents = async () => {
      const q = query(collection(db, "appointments"));
      const snapshot = await getDocs(q);
      return snapshot.docs.map(doc => ({
        title: `${doc.data().service} - ${doc.data().clientName}`,
        start: doc.data().date,
        extendedProps: {
          client: doc.data().clientName
        }
      }));
    }

    const generateReports = async () => {
      const snapshot = await getDocs(collection(db, "appointments"));
      const servicesCount = {};
      
      snapshot.forEach(doc => {
        const service = doc.data().service;
        servicesCount[service] = (servicesCount[service] || 0) + 1;
      });

      if(chartInstance) chartInstance.destroy();
      
      const ctx = document.getElementById('reportsChart').getContext('2d');
      chartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: Object.keys(servicesCount),
          datasets: [{
            data: Object.values(servicesCount),
            backgroundColor: ['#64ffff', '#3264ff', '#1a1a3a'],
            borderColor: '#0a0a1a'
          }]
        }
      });
    }

    const showAppointments = async () => {
      const appointmentsList = document.getElementById('appointmentsList');
      appointmentsList.innerHTML = '';

      const q = query(collection(db, "appointments"), orderBy("timestamp", "desc"));
      const querySnapshot = await getDocs(q);

      querySnapshot.forEach((doc) => {
        const data = doc.data();
        const item = document.createElement('div');
        item.className = 'appointment-item grid grid-cols-3 gap-4';

        const date = new Date(data.date).toLocaleString('ro-RO', {
          weekday: 'long',
          day: 'numeric',
          month: 'long',
          hour: '2-digit',
          minute: '2-digit'
        });

        item.innerHTML = `
          <div class="appointment-name">${data.clientName}</div>
          <div class="appointment-time">${date}</div>
          <div class="appointment-service">${data.service}</div>
          <div class="col-span-3 flex gap-2 justify-end">
            <button class="edit-btn px-2 py-1 bg-blue-600 rounded" data-id="${doc.id}">
              <i class="fas fa-edit"></i>
            </button>
            <button class="delete-btn px-2 py-1 bg-red-600 rounded" data-id="${doc.id}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;

        item.querySelector('.delete-btn').addEventListener('click', async (e) => {
          await deleteDoc(doc(db, "appointments", e.target.closest('button').dataset.id));
          showAppointments();
          generateReports();
        });

        item.querySelector('.edit-btn').addEventListener('click', async (e) => {
          const newDate = prompt('Noua datƒÉ (ex: "joi 15:30"):', date);
          if(newDate) {
            const parsedDate = parseDate(newDate);
            try {
              validateDateTime(parsedDate);
              await updateDoc(doc(db, "appointments", e.target.closest('button').dataset.id), {
                date: parsedDate.toISOString()
              });
              showAppointments();
              generateReports();
            } catch (error) {
              alert(error.message);
            }
          }
        });

        appointmentsList.appendChild(item);
      });
    }

    function parseDate(input) {
      const now = new Date();
      const romanianMonths = {
        'ianuarie': 0, 'februarie': 1, 'martie': 2, 'aprilie': 3,
        'mai': 4, 'iunie': 5, 'iulie': 6, 'august': 7,
        'septembrie': 8, 'octombrie': 9, 'noiembrie': 10, 'decembrie': 11
      };

      let finalDate = new Date(now);
      
      const dateMatch = input.match(/(\d{1,2})\s+(ianuarie|februarie|martie|aprilie|mai|iunie|iulie|august|septembrie|octombrie|noiembrie|decembrie)\s*(ora)?\s*(\d{1,2})?/i);
      
      if (dateMatch) {
        const day = parseInt(dateMatch[1]);
        const month = romanianMonths[dateMatch[2].toLowerCase()];
        const year = now.getFullYear();
        
        finalDate.setFullYear(year, month, day);
        
        if (dateMatch[4]) {
          const hours = parseInt(dateMatch[4]);
          finalDate.setHours(hours, 0, 0, 0);
        }
      }
      else {
        const weekdays = ['duminicƒÉ', 'luni', 'mar»õi', 'miercuri', 'joi', 'vineri', 's√¢mbƒÉtƒÉ'];
const weekdayMatch = input.match(new RegExp(\\b(${weekdays.join('|')})\\b, 'i'));
    if (weekdayMatch) {
      const targetDay = weekdays.findIndex(d => d === weekdayMatch[1].toLowerCase());
      const currentDay = now.getDay();
      let dayOffset = targetDay - currentDay;
      if (dayOffset < 0) dayOffset += 7;
      finalDate.setDate(now.getDate() + dayOffset);
    }
    else if (input.toLowerCase().includes('m√¢ine')) {
      finalDate.setDate(now.getDate() + 1);
    }

    const timeMatch = input.match(/(\d{1,2})(?:[:.](\d{2}))?\s*(am|pm)?/i);
    if (timeMatch) {
      let hours = parseInt(timeMatch[1]);
      const minutes = timeMatch[2] ? parseInt(timeMatch[2]) : 0;
      const period = timeMatch[3]?.toLowerCase();

      if (period === 'pm' && hours < 12) hours += 12;
      if (period === 'am' && hours === 12) hours = 0;

      finalDate.setHours(hours, minutes, 0, 0);
    }
  }

  if (finalDate.toString() === 'Invalid Date') throw new Error('DatƒÉ invalidƒÉ');
  
  return finalDate;
}

async function checkAvailability(date) {
  const start = new Date(date);
  start.setMinutes(0, 0, 0);
  
  const end = new Date(date);
  end.setMinutes(59, 59, 999);

  const colRef = collection(db, "appointments");
  const q = query(
    colRef, 
    where("date", ">=", start.toISOString()),
    where("date", "<=", end.toISOString())
  );
  
  const snapshot = await getDocs(q);
  return snapshot.empty;
}

document.getElementById('toggleViewBtn').addEventListener('click', () => {
  const password = prompt('Introdu parola admin:');
  if(password === '1234') {
    const adminView = document.getElementById('adminView');
    adminView.style.display = adminView.style.display === 'none' ? 'block' : 'none';
    if(adminView.style.display === 'block') {
      showAppointments();
      initCalendar();
      generateReports();
    }
  } else {
    alert('ParolƒÉ incorectƒÉ!');
  }
});

async function handleUserMessage(text) {
  try {
    const name = extractUserName(text);
    if(name) {
      if(!validateName(name)) {
        return "‚ö†Ô∏è Nume invalid. Te rog folose»ôte doar litere »ôi spa»õii (2-30 caractere).";
      }
      localStorage.setItem('chatbotUserName', name);
    }

    const serviceMatch = text.match(/pensat|masaj sculptural bucal|√Ængrijire facialƒÉ premium/i);
    const date = parseDate(text);
    
    validateDateTime(date);

    const isAvailable = await checkAvailability(date);
    if (!isAvailable) {
      return "‚è∞ Ne pare rƒÉu, intervalul este deja ocupat. VƒÉ rugƒÉm alege»õi altƒÉ orƒÉ.";
    }
    
    const saved = await saveAppointment(name, date, serviceMatch[0]);
    if (saved) {
      const formattedDate = date.toLocaleString('ro-RO', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        hour: '2-digit',
        minute: '2-digit'
      });
      return `‚úÖ Programare confirmatƒÉ!<br><br>
        üë§ ${name}<br>
        üìÖ ${formattedDate}<br>
        üíº ${serviceMatch[0]}`;
    }
    
    return await getAIChatResponse(text);

  } catch (error) {
    return `‚ö†Ô∏è Eroare: ${error.message}`;
  }
}

async function saveAppointment(name, date, service) {
  try {
    await addDoc(collection(db, "appointments"), {
      clientName: name,
      date: date.toISOString(),
      service: service.toLowerCase(),
      timestamp: new Date().toISOString(),
      status: "confirmed"
    });
    return true;
  } catch (error) {
    console.error("Eroare salvare:", error);
    return false;
  }
}

function extractUserName(text) {
  const patterns = [
    /(?:sunt|numele\s*(meu)?\s*este?|mƒÉ\s*cheamƒÉ)\s+([A-Za-z»ò»ô»ö»õ√Ç√¢√é√ÆƒÇƒÉ]+)/i,
    /\b([A-Z»ò»ö√ÇƒÇ√é][a-z»ô»õ√¢√ÆƒÉ]+)\b/
  ];
  
  for (const pattern of patterns) {
    const match = text.match(pattern);
    if (match) {
      const name = (match[2] || match[1]).trim();
      return name;
    }
  }
  return null;
}

async function getAIChatResponse(prompt) {
  try {
    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt: prompt })
    });
    const data = await response.json();
    return data.reply;
  } catch (error) {
    return '‚è≥ Momentan avem dificultƒÉ»õi tehnice. VƒÉ rugƒÉm sƒÉ √Æncerca»õi mai t√¢rziu.';
  }
}

sendButton.addEventListener('click', async () => {
  const text = userInput.value.trim();
  if (!text) return;

  userInput.value = '';
  addMessage(text, true);

  try {
    const response = await handleUserMessage(text);
    addMessage(response, false);
  } catch (error) {
    addMessage("‚ö†Ô∏è A apƒÉrut o eroare. VƒÉ rugƒÉm √Æncerca»õi din nou.", false);
  }
});

userInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') sendButton.click();
});

document.getElementById('refreshAppointments').addEventListener('click', () => {
  showAppointments();
  generateReports();
});

document.getElementById('addAppointmentBtn').addEventListener('click', async () => {
  const name = prompt('Nume client:');
  const dateInput = prompt('DatƒÉ »ôi orƒÉ (ex: "joi 15:30"):');
  const service = prompt('Serviciu:');

  if(name && dateInput && service) {
    try {
      if(!validateName(name)) throw new Error('Nume invalid');
      const date = parseDate(dateInput);
      validateDateTime(date);
      
      if(await checkAvailability(date)) {
        await saveAppointment(name, date, service);
        showAppointments();
        generateReports();
      } else {
        alert('Interval ocupat!');
      }
    } catch (error) {
      alert(error.message);
    }
  }
});
</script>
</body> 
</html>
